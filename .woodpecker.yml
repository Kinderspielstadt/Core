when:
  - event: [pull_request, tag]
  - event: push
    branch:
      - ${CI_REPO_DEFAULT_BRANCH}

variables:
  - &node_image "docker.io/node:22-alpine"
  - &cache_image "docker.io/meltwater/drone-cache:v1.4.0"
  - &buildx_plugin "docker.io/woodpeckerci/plugin-docker-buildx:3.1.0"

steps:
  - name: â™»ï¸ Restore Cache
    image: *cache_image
    settings:
      backend: filesystem
      restore: true
      cache_key: volume
      archive_format: gzip
      mount:
        - "webapp/node_modules"
        - ".docker/cache"
    volumes:
      - /tmp/cache:/tmp/cache

  - name: ğŸ“¦ Install Web App
    depends_on:
      - â™»ï¸ Restore Cache
    image: *node_image
    directory: webapp/
    commands:
      - corepack enable
      - pnpm install --frozen-lockfile

  - name: ğŸ§½ Format Check Web App
    depends_on:
      - ğŸ“¦ Install Web App
    image: *node_image
    directory: webapp/
    commands:
      - corepack enable
      - pnpm lint

  - name: ğŸ” Lint Web App
    depends_on:
      - ğŸ§½ Format Check Web App
    image: *node_image
    directory: webapp/
    commands:
      - corepack enable
      - pnpm lint

  - name: âœ¨ Generate Version
    depends_on:
      - ğŸ” Lint Web App
    image: *node_image
    directory: webapp/
    commands:
      - corepack enable
      - pnpm generate-version

  - name: ğŸ—ï¸ Build Web App
    depends_on:
      - âœ¨ Generate Version
    image: *node_image
    directory: webapp/
    commands:
      - corepack enable
      - pnpm build

  - name: ğŸ³ Build Server and publish
    depends_on:
      - ğŸ—ï¸ Build Web App
    image: *buildx_plugin
    settings:
      repo: git.kinderspielstadt.de/kispi/core
      dockerfile: Dockerfile
      tag:
        [
          latest,
          "${CI_COMMIT_TAG}",
          "${CI_COMMIT_TAG%.*}",
          "${CI_COMMIT_TAG%%.*}",
        ]
      cache-from: type=local,src=.docker/cache
      cache-to: type=local,dest=.docker/cache
      logins:
        - registry: https://git.kinderspielstadt.de
          username:
            from_secret: docker_username
          password:
            from_secret: docker_password

  - name: ğŸ”¨ Rebuild Cache
    depends_on:
      - ğŸ³ Build Server and publish
    image: *cache_image
    settings:
      backend: filesystem
      rebuild: true
      cache_key: volume
      archive_format: gzip
      mount:
        - "webapp/node_modules"
        - ".docker/cache"
    volumes:
      - /tmp/cache:/tmp/cache
